<% layout("/layouts/boilerplate") %>

<div class="show-page-content">
  <script type="application/json" id="listing-data">
    <%- JSON.stringify({
        _id: listing._id.toString(),
        title: listing.title,
        description: listing.description,
        price: listing.price,
        location: listing.location,
        country: listing.country,
        image: listing.image,
        geometry: listing.geometry,
        category: listing.category
      }) %>
  </script>

  <div class="container-lg mt-5 mb-5">
    <a href="/listings" class="back-link d-inline-block mb-4">
      <i class="fa-solid fa-arrow-left me-1"></i> Back to Explore
    </a>

    <div class="row">
      <div class="col-lg-7">
        <% const imgUrl = (listing.image && listing.image.url) ? listing.image.url
        : 'https://images.unsplash.com/photo-1566073771259-6a8506099945?w=1000&q=80'; %>
        <img
          src="<%= imgUrl %>"
          class="show-listing-image w-100"
          alt="Listing Image"
          loading="lazy"
        />
      </div>

      <div class="col-lg-5 ps-lg-5 mt-4 mt-lg-0">
        <h1 class="show-listing-title mb-3"><%= listing.title %></h1>

        <% if (listing.owner && listing.owner.username) { %>
        <span class="badge owner-badge mb-3">
          <i class="fa-solid fa-user-check me-1"></i>
          Owner: <%= listing.owner.username %>
        </span>
        <% } %>

        <p class="card-text text-secondary fs-5"><%= listing.description %></p>

        <div class="show-listing-price mt-4 mb-4">
          &#8377; <%= listing.price.toLocaleString("en-IN") %>
          <span class="text-secondary fs-6 fw-normal"><b>/ night</b></span>
        </div>

        <ul class="list-group list-group-flush info-list">
          <li class="list-group-item d-flex align-items-center">
            <i class="fa-solid fa-location-dot me-2"></i> <%= listing.location %>
          </li>
          <li class="list-group-item d-flex align-items-center">
            <i class="fa-solid fa-globe me-2"></i> <%= listing.country %>
          </li>
        </ul>

        <% if (currUser && listing.owner && listing.owner.equals(currUser._id)) {
        %>
        <div
          class="d-flex gap-2 align-items-center justify-content-between mt-4 pt-4 border-top"
        >
          <a href="/listings/<%= listing._id %>/edit" class="btn btn-dark">
            <i class="fa-solid fa-pen-to-square me-1"></i> Edit
          </a>
          <form
            method="POST"
            action="/listings/<%= listing._id %>?_method=DELETE"
            class="d-inline"
          >
            <button class="btn btn-danger">
              <i class="fa-solid fa-trash me-1"></i> Delete
            </button>
          </form>
        </div>
        <% } %>
      </div>
    </div>
  </div>
  <% if (currUser) { %>
  <div class="listing-section">
    <div class="container-lg">
      <div class="row">
        <div class="col-md-8 offset-md-2">
          <h3 class="mb-3">Leave a Review</h3>
          <form
            action="/listings/<%= listing._id %>/reviews"
            method="POST"
            class="mb-4 needs-validation"
            novalidate
          >
            <div class="mb-3">
              <label for="rating" class="form-label">Rating</label>
              <div class="star-rating-form" id="rating">
                <% for (let i = 5; i >= 1; i--) { %>
                <input
                  type="radio"
                  id="star<%= i %>"
                  name="review[rating]"
                  value="<%= i %>"
                  required
                />
                <label for="star<%= i %>" title="<%= i %> stars">★</label>
                <% } %>
              </div>
              <div class="invalid-feedback mt-1">Please select a rating.</div>
            </div>

            <div class="mb-3">
              <label for="comment" class="form-label">Review</label>
              <textarea
                name="review[comment]"
                id="comment"
                rows="4"
                class="form-control"
                required
              ></textarea>
              <div class="invalid-feedback">
                Please provide a review comment.
              </div>
            </div>

            <button type="submit" class="btn btn-primary">Submit Review</button>
          </form>
        </div>
      </div>
    </div>
  </div>
  <% } %>

  <div class="listing-section-full bg-light">
    <div class="container-lg">
      <div class="row">
        <div class="col-lg-10 offset-lg-1">
          <div class="reviews-shell">
            <% const reviews = listing.reviews || []; const reviewCount =
            reviews.length; const averageRating = reviewCount ?
            reviews.reduce((total, review) => total + (review.rating || 0), 0) /
            reviewCount : null; const averageRatingDisplay = averageRating !==
            null ? averageRating.toFixed(1) : null; const previewReviews =
            reviewCount > 0 ? reviews.slice(0, Math.min(reviewCount, 4)) : []; %>
            <div class="reviews-header">
              <div class="reviews-heading">
                <h3 class="mb-1">
                  <i class="fa-solid fa-star me-2 text-warning"></i>
                  Guest Experiences
                </h3>
                <p class="mb-0 text-secondary">
                  Feedback from travelers who stayed here.
                </p>
              </div>
              <div class="reviews-meta">
                <% if (averageRatingDisplay) { %>
                <div
                  class="rating-pill"
                  aria-label="Average rating of <%= averageRatingDisplay %> out of 5"
                >
                  <span><%= averageRatingDisplay %></span>
                  <div class="star-rating-static" aria-hidden="true">
                    <div
                      class="star-rating-static-inner"
                      style="--rating: <%= averageRating %>"
                    ></div>
                  </div>
                </div>
                <% } %>
                <span class="text-secondary fw-semibold">
                  <%= reviewCount %> <%= reviewCount === 1 ? "review" :
                  "reviews" %>
                </span>
                <% if (reviewCount > 0) { %>
                <button
                  type="button"
                  class="btn btn-outline-dark"
                  data-bs-toggle="modal"
                  data-bs-target="#reviewsModal"
                >
                  View all
                </button>
                <% } %>
              </div>
            </div>

            <% if (reviewCount > 0) { %>
            <div class="review-grid">
              <% previewReviews.forEach((review) => { const authorName =
              review.author ? review.author.username : "Anonymous"; const
              avatarInitial = authorName.trim().charAt(0).toUpperCase(); const
              reviewDate = review.updatedAt || review.createdAt; const
              reviewDateDisplay = reviewDate ? new
              Date(reviewDate).toLocaleDateString("en-IN", { day: "numeric",
              month: "short", year: "numeric", }) : null; %>
              <article class="review-card">
                <header>
                  <div class="review-avatar" aria-hidden="true">
                    <%= avatarInitial %>
                  </div>
                  <div class="review-author">
                    <span><%= authorName %></span>
                    <div class="review-meta">
                      <div class="star-rating-static" aria-hidden="true">
                        <div
                          class="star-rating-static-inner"
                          style="--rating: <%= review.rating %>"
                        ></div>
                      </div>
                      <span class="visually-hidden"
                        ><%= review.rating %> out of 5 stars</span
                      >
                      <% if (reviewDateDisplay) { %>
                      <time
                        class="review-date"
                        datetime="<%= new Date(reviewDate).toISOString() %>"
                      >
                        <%= reviewDateDisplay %>
                      </time>
                      <% } %>
                    </div>
                  </div>
                </header>
                <p class="review-body"><%= review.comment %></p>

                <% if (currUser && review.author &&
                review.author.equals(currUser._id)) { %>
                <div class="review-actions">
                  <form
                    method="POST"
                    action="/listings/<%= listing._id %>/reviews/<%= review._id %>?_method=DELETE"
                  >
                    <button class="btn btn-sm btn-outline-danger">
                      <i class="fa-solid fa-trash me-1"></i> Delete
                    </button>
                  </form>
                </div>
                <% } %>
              </article>
              <% }) %>
            </div>
            <% if (reviewCount > previewReviews.length) { %>
            <div class="text-center mt-4">
              <button
                type="button"
                class="btn btn-outline-primary px-4"
                data-bs-toggle="modal"
                data-bs-target="#reviewsModal"
              >
                Show the remaining <%= reviewCount - previewReviews.length %> <%=
                (reviewCount - previewReviews.length) === 1 ? "review" :
                "reviews" %>
              </button>
            </div>
            <% } %> <% } else { %>
            <div class="empty-reviews">
              <p class="mb-1 fw-semibold">No reviews yet.</p>
              <% if (currUser) { %>
              <p class="mb-0">Be the first guest to share your experience.</p>
              <% } else { %>
              <p class="mb-0">
                <a
                  href="/login"
                  class="text-decoration-none fw-semibold text-dark"
                >
                  Log in
                </a>
                to be the first to leave a review.
              </p>
              <% } %>
            </div>
            <% } %>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="listing-section-full">
    <div class="container-lg">
      <div class="row">
        <div class="col-md-8 offset-md-2">
          <h3 class="mb-3">
            <i class="fa-solid fa-map-location-dot me-1"></i> Where you'll be
          </h3>
          <div id="map"></div>
        </div>
      </div>
    </div>
  </div>

  <script src="/js/map.js"></script>
  <script>
    // NEW: Bootstrap Client-side Validation Script
    (function () {
      "use strict";

      // Fetch all the forms we want to apply custom Bootstrap validation styles to
      var forms = document.querySelectorAll(".needs-validation");

      // Loop over them and prevent submission
      Array.prototype.slice.call(forms).forEach(function (form) {
        form.addEventListener(
          "submit",
          function (event) {
            if (!form.checkValidity()) {
              event.preventDefault();
              event.stopPropagation();
            }

            form.classList.add("was-validated");
          },
          false
        );
      });
    })();
  </script>

  <div
    class="modal fade"
    id="reviewsModal"
    tabindex="-1"
    aria-labelledby="reviewsModalLabel"
    aria-hidden="true"
  >
    <div
      class="modal-dialog modal-dialog-centered modal-lg modal-dialog-scrollable"
    >
      <div class="modal-content">
        <div class="modal-header">
          <h4 id="reviewsModalLabel" class="modal-title">
            Reviews for <%= listing.title %>
          </h4>
          <button
            type="button"
            class="btn-close"
            data-bs-dismiss="modal"
            aria-label="Close"
          ></button>
        </div>
        <div class="modal-body">
          <% if (listing.reviews && listing.reviews.length > 0) { %>
          <div class="reviews-modal-list">
            <% listing.reviews.forEach((review) => { const authorName =
            review.author ? review.author.username : "Anonymous"; const
            avatarInitial = authorName.trim().charAt(0).toUpperCase(); const
            reviewDate = review.updatedAt || review.createdAt; const
            reviewDateDisplay = reviewDate ? new
            Date(reviewDate).toLocaleDateString("en-IN", { day: "numeric",
            month: "short", year: "numeric", }) : null; %>
            <article class="review-card">
              <header>
                <div class="review-avatar" aria-hidden="true">
                  <%= avatarInitial %>
                </div>
                <div class="review-author">
                  <span><%= authorName %></span>
                  <div class="review-meta">
                    <div class="star-rating-static" aria-hidden="true">
                      <div
                        class="star-rating-static-inner"
                        style="--rating: <%= review.rating %>"
                      ></div>
                    </div>
                    <span class="visually-hidden"
                      ><%= review.rating %> out of 5 stars</span
                    >
                    <% if (reviewDateDisplay) { %>
                    <time
                      class="review-date"
                      datetime="<%= new Date(reviewDate).toISOString() %>"
                    >
                      <%= reviewDateDisplay %>
                    </time>
                    <% } %>
                  </div>
                </div>
              </header>
              <p class="review-body"><%= review.comment %></p>

              <% if (currUser && review.author &&
              review.author.equals(currUser._id)) { %>
              <div class="review-actions">
                <form
                  method="POST"
                  action="/listings/<%= listing._id %>/reviews/<%= review._id %>?_method=DELETE"
                >
                  <button class="btn btn-sm btn-outline-danger">
                    <i class="fa-solid fa-trash me-1"></i> Delete
                  </button>
                </form>
              </div>
              <% } %>
            </article>
            <% }) %>
          </div>
          <% } else { %>
          <p class="text-secondary mb-0">
            No reviews yet. Be the first to leave one!
          </p>
          <% } %>
        </div>
        <div class="modal-footer">
          <button
            type="button"
            class="btn btn-secondary"
            data-bs-dismiss="modal"
          >
            Close
          </button>
        </div>
      </div>
    </div>
  </div>

  </div>
